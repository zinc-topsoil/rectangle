TODO: Refactor the main logic.
Temporary note: need review.
